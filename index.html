<!DOCTYPE html>
<html lang="eu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hitzak eta Zenbakiak Ikasten</title>
    <link href="https://fonts.googleapis.com/css2?family=Comic+Neue:wght@700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-bg: #e0f7fa;
            --container-bg: #ffffff;
            --primary-text: #004d40;
            --accent-color: #00796b;
            --border-color-light: #b2dfdb;
            --border-color-dashed: #4db6ac;
            --box-bg: #e0f2f7;
            --tile-bg: #ffcc80;
            --tile-border: #f57c00;
            --tile-text: #bf360c;
            --number-button-bg: #81d4fa; /* Light blue for number buttons */
            --number-button-border: #29b6f6; /* Darker blue */
            --number-button-text: #01579b; /* Dark blue text */
            --number-button-hover-bg: #4fc3f7;
            --correct-flash-bg: #a7ffeb;
            --incorrect-flash-bg: #ffcdd2;
            --level-up-flash-bg: #fff9c4;
            --feedback-correct: #2e7d32;
            --feedback-info: #00796b;
            --feedback-level-up: #ff6f00;
            --feedback-incorrect: #c62828; /* Red for incorrect number */
            --font-family-normal: 'Arial Rounded MT Bold', 'Helvetica Rounded', Arial, sans-serif;
            --font-family-child: 'Comic Neue', 'Comic Sans MS', cursive, sans-serif;
            --box-size: 50px;
            --tile-size: 45px;
            --number-button-size: 55px;
            --border-radius: 8px;
            --button-bg: #009688;
            --button-text: #ffffff;
            --button-hover-bg: #00796b;
            --options-button-bg: #607d8b;
            --options-button-hover-bg: #546e7a;
            --back-button-bg: #ff9800; /* Orange back buttons */
            --back-button-border: #f57c00;
            --back-button-hover-bg: #f57c00;
            --modal-bg: rgba(0, 0, 0, 0.6);
            --modal-content-bg: #ffffff;
            --emoji-font-size: 80px; /* Word game emoji */
            --number-emoji-font-size: 40px; /* Number game emoji size */
            --button-emoji-font-size: 30px; /* Game selection button emoji */
        }

        /* Base styles */
        body {
            font-family: var(--font-family-normal);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            min-height: 100vh;
            background-color: var(--primary-bg);
            color: var(--primary-text);
            margin: 0;
            padding: 20px 10px;
            box-sizing: border-box;
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            transition: font-family 0.3s ease;
        }
        body.font-child { font-family: var(--font-family-child); }
        body.font-child h1, body.font-child h2, body.font-child button, body.font-child label, body.font-child .number-button {
             font-family: var(--font-family-child);
             font-weight: bold;
        }
        body.font-child .letter-tile, body.font-child .word-box {
             font-family: var(--font-family-child);
             font-weight: bold;
        }

        h1 { color: var(--accent-color); margin-bottom: 20px; text-align: center; }
        h2 { color: var(--accent-color); margin-bottom: 25px; text-align: center; }

        /* Common Screen Container Style */
        .screen {
            display: none; /* Hidden by default */
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            text-align: center;
            background-color: var(--container-bg);
            padding: 20px; /* Reduced padding slightly */
            border-radius: 15px;
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.1);
            width: 90%;
            max-width: 700px;
            margin-top: 20px;
            position: relative; /* Needed for absolute positioning of back button */
        }
        .screen.active {
            display: flex; /* Show active screen */
        }

        /* Common Controls Container Style (for back buttons etc.) */
        .controls-container {
             width: 100%;
             display: flex;
             justify-content: flex-start; /* Default alignment */
             margin-bottom: 15px;
             padding: 0 5px; /* Match game controls padding */
             box-sizing: border-box;
             position: absolute; /* Position relative to parent .screen */
             top: 15px; /* Adjust position from top */
             left: 15px; /* Adjust position from left */
             max-width: calc(100% - 30px); /* Prevent overflow */
        }

         /* Common Back Button Style */
        .back-button {
             padding: 10px 15px;
             font-size: 0.9em;
             font-weight: bold;
             color: var(--button-text);
             background-color: var(--back-button-bg);
             border: none;
             border-radius: var(--border-radius);
             cursor: pointer;
             transition: background-color 0.2s ease;
             border-bottom: 3px solid var(--back-button-border);
             line-height: 1; /* Ensure text aligns well */
         }
         .back-button:hover, .back-button:focus {
             background-color: var(--back-button-hover-bg);
             outline: none;
         }

         .maila-button {
  padding: 10px 15px;
  font-size: 0.9em;
  font-weight: bold;
  color: var(--button-text);
  background-color: #00796b;
  border: none;
    border-bottom-width: medium;
    border-bottom-style: none;
    border-bottom-color: currentcolor;
  border-radius: var(--border-radius);
  transition: background-color 0.2s ease;
  border-bottom: 3px solid #a0d2d0;
  line-height: 1;
}


        /* Game Selection Screen */
        #game-selection-screen h2 { margin-top: 10px; } /* Add space below title */
        #game-selection-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 20px;
            width: 100%;
            max-width: 500px;
            margin-top: 20px; /* Space above buttons */
        }
        .game-select-button {
            padding: 25px 15px;
            font-size: 1.2em;
            font-weight: bold;
            color: var(--button-text);
            background-color: var(--button-bg);
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: background-color 0.2s ease, transform 0.1s ease;
            border-bottom: 4px solid var(--button-hover-bg);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 10px;
            min-height: 120px;
        }
        .game-select-button .emoji-icon { font-size: var(--button-emoji-font-size); line-height: 1; }
        .game-select-button:hover, .game-select-button:focus { background-color: var(--button-hover-bg); transform: translateY(-2px); outline: none; }
        .game-select-button:active { transform: translateY(0px); }

        /* Word Theme Selection Screen */
        #word-theme-screen .controls-container { /* Style for theme back button container */
             /* Uses common .controls-container styles */
         }
        #word-theme-screen h2 { margin-top: 50px; margin-bottom: 15px; } /* Add space below back button */
        #theme-buttons { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; width: 100%; }
        .theme-button { padding: 15px 10px; font-size: 1em; font-weight: bold; color: var(--button-text); background-color: var(--button-bg); border: none; border-radius: var(--border-radius); cursor: pointer; transition: background-color 0.2s ease, transform 0.1s ease; border-bottom: 3px solid var(--button-hover-bg); display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 8px; min-height: 100px; }
        .theme-button .emoji-icon { font-size: calc(var(--button-emoji-font-size) * 0.8); line-height: 1; margin-bottom: 5px; }
        .theme-button span { display: block; }
        .theme-button:hover, .theme-button:focus { background-color: var(--button-hover-bg); transform: translateY(-2px); outline: none; }
        .theme-button:active { transform: translateY(0px); }

        /* General Game Screen Container */
        .game-content-area {
            background-color: var(--container-bg);
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
            box-sizing: border-box;
            margin-bottom: 15px;
        }

        /* Word Game Screen Specific Styles */
        #word-game-screen { display: none; width: 100%; max-width: 600px; flex-direction: column; align-items: center; background: none; box-shadow: none; padding: 0; margin-top: 0;} /* Remove screen styles */
        #word-game-screen .controls-container { /* Use specific controls for word game */
            width: 100%;
            max-width: 600px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 0;
            margin-bottom: 15px;
            padding: 0 5px;
            box-sizing: border-box;
            gap: 10px;
            position: static; /* Override absolute positioning */
         }
        .control-buttons { display: flex; gap: 10px; }
        #options-button { /* Style options button */
             padding: 10px 15px;
             font-size: 1em;
             font-weight: bold;
             color: var(--button-text);
             border: none;
             border-radius: var(--border-radius);
             cursor: pointer;
             transition: background-color 0.2s ease;
             background-color: var(--options-button-bg);
             border-bottom: 3px solid var(--options-button-hover-bg);
         }
        #options-button:hover, #options-button:focus { background-color: var(--options-button-hover-bg); outline: none; }
        #level-indicator { font-size: 1.1em; font-weight: bold;
  padding: 10px 15px;
  color: var(--button-text);
  background-color: #00796b;
  border: none;
    border-bottom-width: medium;
    border-bottom-style: none;
    border-bottom-color: currentcolor;
  border-radius: var(--border-radius);
  cursor: pointer;
  transition: background-color 0.2s ease;
  border-bottom: 3px solid #a0d2d0;
  line-height: 1;
}
        #emoji-container { margin-bottom: 20px; height: 150px; width: 100%; display: flex; align-items: center; justify-content: center; font-size: var(--emoji-font-size); line-height: 1; color: #333; }
        #word-boxes-container { display: flex; gap: 8px; margin-bottom: 25px; flex-wrap: wrap; justify-content: center; min-height: calc(var(--box-size) + 4px); }
        .word-box { width: var(--box-size); height: var(--box-size); background-color: var(--box-bg); border: 2px dashed var(--border-color-dashed); border-radius: var(--border-radius); display: flex; align-items: center; justify-content: center; font-size: calc(var(--box-size) * 0.6); font-weight: bold; color: var(--accent-color); transition: background-color 0.2s ease, transform 0.1s ease, border-style 0.2s; position: relative; }
        .word-box.filled { border-style: solid; background-color: #c8e6c9; }
        .word-box.correct-flash { animation: flash-correct 0.5s ease; }
        .word-box.incorrect-flash { animation: flash-incorrect 0.5s ease; }
        .word-box.level-up-flash { animation: flash-level-up 1s ease; }
        #letter-pool-container { display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; padding: 15px; border-radius: var(--border-radius); min-height: calc(var(--tile-size) + 10px); width: 100%; box-sizing: border-box; border: 1px solid var(--border-color-light); }
        .letter-tile { width: var(--tile-size); height: var(--tile-size); background-color: var(--tile-bg); border: 1px solid #ffa726; border-bottom: 4px solid var(--tile-border); border-radius: var(--border-radius); display: flex; align-items: center; justify-content: center; font-size: calc(var(--tile-size) * 0.6); font-weight: bold; color: var(--tile-text); cursor: grab; transition: background-color 0.2s, opacity 0.2s, transform 0.1s, box-shadow 0.2s; touch-action: none; position: relative; }
        .letter-tile.dragging { opacity: 0.5; cursor: grabbing; box-shadow: 0 4px 8px rgba(0,0,0,0.2); transform: scale(1.1); z-index: 1000; }
        .touch-ghost { position: absolute; pointer-events: none; opacity: 0.8; z-index: 1001; }
        #word-feedback-message { margin-top: 15px; font-size: 1.1em; font-weight: bold; min-height: 25px; color: var(--feedback-info); text-align: center; transition: opacity 0.5s ease, color 0.5s ease; padding: 0 5px; }
        #word-feedback-message.correct { color: var(--feedback-correct); }
        #word-feedback-message.level-up { color: var(--feedback-level-up); }

        /* Number Game Screen Specific Styles */
        #number-game-screen { display: none; width: 100%; max-width: 600px; flex-direction: column; align-items: center; background: none; box-shadow: none; padding: 0; margin-top: 0; } /* Remove screen styles */
        #number-game-screen .controls-container { /* Uses common .controls-container */
             position: static; /* Override absolute positioning */
             margin-bottom: 15px;
             padding: 0 5px;
         }
        #number-game-screen .game-content-area h2 { margin-top: 10px; } /* Space below title */
        #number-emoji-display { display: flex; flex-wrap: wrap; justify-content: center; align-items: center; gap: 10px; margin-bottom: 30px; min-height: 100px; width: 100%; font-size: var(--number-emoji-font-size); }
        #number-buttons-container { display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; width: 100%; max-width: 400px; margin-bottom: 20px; }
        .number-button { width: var(--number-button-size); height: var(--number-button-size); background-color: var(--number-button-bg); border: none; border-bottom: 4px solid var(--number-button-border); border-radius: var(--border-radius); display: flex; align-items: center; justify-content: center; font-size: calc(var(--number-button-size) * 0.5); font-weight: bold; color: var(--number-button-text); cursor: pointer; transition: background-color 0.2s, transform 0.1s; }
        .number-button:hover, .number-button:focus { background-color: var(--number-button-hover-bg); transform: translateY(-2px); outline: none; }
        .number-button:active { transform: translateY(0px); }
        .number-button.correct-flash { animation: flash-correct-num 0.5s ease; }
        .number-button.incorrect-flash { animation: flash-incorrect-num 0.5s ease; }
        #number-feedback-message { margin-top: 15px; font-size: 1.2em; font-weight: bold; min-height: 30px; color: var(--feedback-info); text-align: center; transition: opacity 0.5s ease, color 0.5s ease; padding: 0 5px; }
        #number-feedback-message.correct { color: var(--feedback-correct); }
        #number-feedback-message.incorrect { color: var(--feedback-incorrect); }

        /* Keyframes */
        @keyframes flash-correct { 0%, 100% { background-color: var(--box-bg); transform: scale(1); } 50% { background-color: var(--correct-flash-bg); transform: scale(1.1); } }
        @keyframes flash-incorrect { 0%, 100% { background-color: var(--box-bg); transform: scale(1); } 50% { background-color: var(--incorrect-flash-bg); transform: scale(0.9); } }
        @keyframes flash-level-up { 0%, 100% { background-color: var(--box-bg); } 50% { background-color: var(--level-up-flash-bg); transform: scale(1.1); } }
        @keyframes flash-correct-num { 0%, 100% { background-color: var(--number-button-bg); transform: scale(1); } 50% { background-color: var(--correct-flash-bg); transform: scale(1.1); } }
        @keyframes flash-incorrect-num { 0%, 100% { background-color: var(--number-button-bg); transform: scale(1); } 50% { background-color: var(--incorrect-flash-bg); transform: scale(0.9); } }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 50% { transform: translateX(5px); } 75% { transform: translateX(-3px); } }


        /* Options Modal Styling (Unchanged) */
        #options-modal { display: none; position: fixed; z-index: 1001; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: var(--modal-bg); align-items: center; justify-content: center; }
        .modal-content { background-color: var(--modal-content-bg); margin: auto; padding: 25px 30px; border: 1px solid #888; width: 80%; max-width: 400px; border-radius: var(--border-radius); box-shadow: 0 5px 15px rgba(0,0,0,0.2); color: var(--primary-text); }
        .modal-content h3 { margin-top: 0; color: var(--accent-color); text-align: center; margin-bottom: 20px; }
        .modal-option { margin-bottom: 15px; }
        .modal-option label { display: block; margin-bottom: 8px; font-weight: bold; }
        .modal-option input[type="radio"], .modal-option select { margin-right: 5px; }
        .modal-option select { padding: 5px 8px; border-radius: 4px; border: 1px solid var(--border-color-light); min-width: 150px; }
        .modal-radio-group label { display: inline-block; margin-right: 15px; font-weight: normal; }
        #modal-close-button { display: block; margin: 20px auto 0; padding: 10px 25px; background-color: var(--options-button-bg); color: var(--button-text); border: none; border-radius: var(--border-radius); cursor: pointer; transition: background-color 0.2s ease; font-weight: bold; }
        #modal-close-button:hover { background-color: var(--options-button-hover-bg); }

        /* Responsive adjustments */
        @media (max-width: 768px) {
             #theme-buttons { grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); }
             #game-selection-buttons { grid-template-columns: 1fr; max-width: 300px;} /* Stack game select buttons */
        }
        @media (max-width: 640px) {
             .theme-button { padding: 12px 8px; font-size: 0.9em; min-height: 90px; }
             .theme-button .emoji-icon { font-size: calc(var(--button-emoji-font-size) * 0.7); }
             :root { --emoji-font-size: 70px; --number-emoji-font-size: 35px; --number-button-size: 50px;}
             #level-indicator { font-size: 1em; padding: 4px 12px; }
             #word-game-screen .controls-container { flex-wrap: wrap; justify-content: center; } /* Allow wrapping */
             .control-buttons { margin-bottom: 10px; }
             #number-buttons-container { grid-template-columns: repeat(auto-fit, minmax(var(--number-button-size), 1fr)); max-width: 100%;} /* Adjust number button layout */
        }
        @media (max-width: 480px) {
            h1 { font-size: 1.5em; }
            :root { --box-size: 40px; --tile-size: 38px; --emoji-font-size: 60px; --button-emoji-font-size: 25px; --number-emoji-font-size: 30px; --number-button-size: 45px;}
            .screen, #word-game-screen .game-content-area, #number-game-screen .game-content-area { padding: 20px 15px; width: 95%; } /* Consistent padding */
            #emoji-container { height: 100px; }
            #word-boxes-container { gap: 5px; margin-bottom: 20px; }
            #letter-pool-container { gap: 8px; padding: 10px; }
            #word-feedback-message, #number-feedback-message { font-size: 1em; min-height: 40px; }
            .theme-button { min-height: 80px; gap: 5px; }
            #word-game-screen .controls-container { flex-direction: column; gap: 10px; }
            #level-indicator { order: -1; }
            .modal-content { width: 90%; padding: 20px; }
            #number-buttons-container { gap: 8px; }
            .controls-container { top: 10px; left: 10px; max-width: calc(100% - 20px); } /* Adjust back button pos */
            #word-theme-screen h2 { margin-top: 45px; } /* Adjust title pos */
        }
         @media (max-width: 360px) {
             h1 { font-size: 1.3em; }
             :root { --box-size: 35px; --tile-size: 33px; --emoji-font-size: 50px; --button-emoji-font-size: 22px; --number-emoji-font-size: 28px; --number-button-size: 40px;}
             #word-boxes-container { gap: 4px; }
             #letter-pool-container { gap: 5px; }
             #theme-buttons { grid-template-columns: repeat(2, 1fr); }
             .theme-button { min-height: 75px; }
             #word-feedback-message, #number-feedback-message { font-size: 0.9em; }
             #options-button, .back-button { font-size: 0.8em; padding: 8px 12px; } /* Common style for back buttons */
             #level-indicator { font-size: 0.9em; padding: 4px 10px;}
             #number-buttons-container { gap: 5px; }
         }
    </style>
</head>
<body>
    <h1>Hitzak eta Zenbakiak Ikasten</h1>

    <div id="game-selection-screen" class="screen active">
        <h2>Aukeratu joko bat</h2>
        <div id="game-selection-buttons">
            <button class="game-select-button" data-game="words">
                <span class="emoji-icon">🔠</span>
                <span>Hitzak</span>
            </button>
            <button class="game-select-button" data-game="numbers">
                 <span class="emoji-icon">🧮</span>
                 <span>Zenbakiak</span>
            </button>
        </div>
    </div>

    <div id="word-theme-screen" class="screen">
         <div class="controls-container">
             <button id="theme-back-button" class="back-button">⬅ Atzera</button> </div>
        <h2>Aukeratu gai bat</h2>
        <div id="theme-buttons">
            <button class="theme-button" data-theme="animaliak"> <span class="emoji-icon">🐾</span> <span>Animaliak</span> </button>
            <button class="theme-button" data-theme="eskola"> <span class="emoji-icon">✏️</span> <span>Eskola</span> </button>
            <button class="theme-button" data-theme="arropa"> <span class="emoji-icon">👕</span> <span>Arropa</span> </button>
            <button class="theme-button" data-theme="koloreak"> <span class="emoji-icon">🎨</span> <span>Koloreak</span> </button>
            <button class="theme-button" data-theme="parkea"> <span class="emoji-icon">🌳</span> <span>Parkea</span> </button>
            <button class="theme-button" data-theme="janaria"> <span class="emoji-icon">🍎</span> <span>Janaria</span> </button>
        </div>
    </div>

    <div id="word-game-screen" class="game-screen"> <div id="word-game-controls" class="controls-container" style="position: static; justify-content: space-between;"> <div class="control-buttons">
                 <button id="word-back-button" class="back-button">⬅ Atzera</button> <button id="options-button">⚙️ Aukerak</button>
              </div>
             <div id="level-indicator">Maila: 1</div>
         </div>
        <div class="game-content-area">
            <div id="emoji-container"></div>
            <div id="word-boxes-container"></div>
            <div id="letter-pool-container"></div>
            <div id="word-feedback-message">Arrastatu letrak kutxetara!</div>
        </div>
    </div>

    <div id="number-game-screen" class="game-screen"> <div class="controls-container" style="position: static;"> <button id="number-back-button" class="back-button">⬅ Atzera</button> </div>
        <div class="game-content-area">
             <h2>Zenbat daude?</h2>
            <div id="number-emoji-display"></div>
            <div id="number-buttons-container"></div>
            <div id="number-feedback-message">Aukeratu zenbaki zuzena!</div>
        </div>
    </div>

    <div id="options-modal">
        <div class="modal-content">
            <h3>Aukerak</h3>
            <div class="modal-option"> <label>Letra mota:</label> <div class="modal-radio-group"> <label> <input type="radio" name="letterCase" value="upper" checked> Letra larriak (ABC) </label> <label> <input type="radio" name="letterCase" value="lower"> Letra xeheak (abc) </label> </div> </div>
            <div class="modal-option"> <label for="font-style-select">Letra-tipoa:</label> <select id="font-style-select"> <option value="normal" selected>Normala</option> <option value="child">Haurrentzako</option> </select> </div>
            <button id="modal-close-button">Itxi</button>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- Configuration ---
            const wordThemes = { /* Themes data */
                animaliak: [ { word: 'katu', emoji: '🐱' }, { word: 'txakur', emoji: '🐶' }, { word: 'arrain', emoji: '🐠' }, { word: 'ahate', emoji: '🦆' }, { word: 'behi', emoji: '🐄' }, { word: 'igel', emoji: '🐸' }, ],
                eskola: [ { word: 'liburu', emoji: '📖' }, { word: 'arkatz', emoji: '✏️' }, { word: 'mahai', emoji: '🪵' }, { word: 'goma', emoji: '🧼' }, { word: 'paper', emoji: '📄' }, ],
                arropa: [ { word: 'txano', emoji: '🧢' }, { word: 'gona', emoji: '👗' }, { word: 'bota', emoji: '👢' }, { word: 'blusa', emoji: '👚' }, { word: 'motz', emoji: '🩳' }, ],
                koloreak: [ { word: 'gorri', emoji: '❤️' }, { word: 'urdin', emoji: '💙' }, { word: 'berde', emoji: '💚' }, { word: 'arrosa', emoji: '🩷' }, { word: 'lila', emoji: '💜' }, ],
                parkea: [ { word: 'zuhaitz', emoji: '🌳' },{ word: 'lore', emoji: '🌸' }, { word: 'banku', emoji: '🪵' }, { word: 'pilota', emoji: '⚽' }, { word: 'hodei', emoji: '☁️' }, ],
                janaria: [ { word: 'madari', emoji: '🍐' }, { word: 'ogi', emoji: '🍞' }, { word: 'mahats', emoji: '🍇' }, { word: 'arrautz', emoji: '🥚' },{ word: 'gazta', emoji: '🧀' }, { word: 'tarta', emoji: '🍰' }, ]
             };
            const numberGameEmojis = ['🍎', '⚽', '🧸', '⭐', '🚗', '🎈', '🎁', '🐶', '🐱', '🚀', '🍓', '🦋', '🌻', '🍦', '🎸'];
            const WORDS_PER_LEVEL = 3;
            const MAX_DISTRACTORS_CAP = 3;
            const COMPLETION_DELAY_MS = 1200;
            const LEVEL_UP_DELAY_MS = 2000;
            const THEME_COMPLETE_DELAY_MS = 2000;
            const NUMBER_CORRECT_DELAY_MS = 1000;

            // --- DOM Elements ---
            const bodyElement = document.body;
            const gameSelectionScreen = document.getElementById('game-selection-screen');
            const wordThemeScreen = document.getElementById('word-theme-screen');
            const wordGameScreen = document.getElementById('word-game-screen'); // Container for word game UI
            const numberGameScreen = document.getElementById('number-game-screen'); // Container for number game UI
            const gameSelectButtons = document.querySelectorAll('.game-select-button');
            const themeButtonsContainer = document.getElementById('theme-buttons');
            const themeBackButton = document.getElementById('theme-back-button');
            const wordBackButton = document.getElementById('word-back-button');
            const numberBackButton = document.getElementById('number-back-button');
            const optionsButton = document.getElementById('options-button');
            const levelIndicator = document.getElementById('level-indicator');
            const wordEmojiContainer = document.getElementById('emoji-container');
            const wordBoxesContainer = document.getElementById('word-boxes-container');
            const letterPoolContainer = document.getElementById('letter-pool-container');
            const wordFeedbackMessage = document.getElementById('word-feedback-message');
            const numberEmojiDisplay = document.getElementById('number-emoji-display');
            const numberButtonsContainer = document.getElementById('number-buttons-container');
            const numberFeedbackMessage = document.getElementById('number-feedback-message');
            const optionsModal = document.getElementById('options-modal');
            const modalCloseButton = document.getElementById('modal-close-button');
            const fontStyleSelect = document.getElementById('font-style-select');
            const letterCaseRadios = document.querySelectorAll('input[name="letterCase"]');

            // --- Game State ---
            let currentWordList = [], currentWordIndex = 0, currentWord = '', currentWordEmoji = '';
            let lettersInBoxes = [], draggedElement = null, ghostElement = null, offsetX = 0, offsetY = 0;
            let currentLevel = 1, wordsCorrectThisLevel = 0;
            let currentNumberCorrect = 0, currentNumberEmoji = '';
            let numberGameActive = false;
            let letterCaseOption = 'upper', fontStyleOption = 'normal';

            // --- Utility Functions ---
            function shuffleArray(array) { for (let i = array.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [array[i], array[j]] = [array[j], array[i]]; } return array; }
            function getRandomInt(min, max) { return Math.floor(Math.random() * (max - min + 1)) + min; }
            function applyOptions() {
                bodyElement.classList.toggle('font-child', fontStyleOption === 'child');
                document.querySelectorAll('.letter-tile, .word-box').forEach(el => { if (el.dataset.letter) { el.textContent = formatLetter(el.dataset.letter); } });
            }
            function formatLetter(letter) { if (!letter) return ''; return letterCaseOption === 'lower' ? letter.toLowerCase() : letter.toUpperCase(); }

            // --- Screen Navigation (Corrected) ---
            function showScreen(screenToShow) {
                // Hide all primary screen containers first
                gameSelectionScreen.classList.remove('active');
                wordThemeScreen.classList.remove('active');
                // Hide specific game UI containers
                wordGameScreen.style.display = 'none';
                numberGameScreen.style.display = 'none';

                // Show the requested primary screen container
                if (screenToShow === 'gameSelection') {
                    gameSelectionScreen.classList.add('active');
                } else if (screenToShow === 'wordThemeSelection') {
                    wordThemeScreen.classList.add('active');
                } else if (screenToShow === 'wordGame') {
                    wordGameScreen.style.display = 'flex'; // Show word game UI container
                } else if (screenToShow === 'numberGame') {
                    numberGameScreen.style.display = 'flex'; // Show number game UI container
                }
                 applyOptions(); // Apply font style
            }

            // --- Word Game Logic ---
            function generateLetterPool(word, level) { const wordLetters = word.toUpperCase().split(''); let finalPoolLetters = [...wordLetters]; const numDistractors = Math.min(Math.max(0, level - 1), MAX_DISTRACTORS_CAP); if (numDistractors > 0) { const alphabet = 'ABCDEFGHIJKLMNÑOPQRSTUVWXYZ'; let distractors = []; let attempts = 0; while (distractors.length < numDistractors && attempts < 100) { const randomLetter = alphabet[Math.floor(Math.random() * alphabet.length)]; if (!wordLetters.includes(randomLetter) && !distractors.includes(randomLetter)) { distractors.push(randomLetter); } attempts++; } finalPoolLetters = finalPoolLetters.concat(distractors); } return shuffleArray(finalPoolLetters); }
            function startWordGame(theme) { if (!wordThemes[theme]) { console.error("Gai ez da aurkitu:", theme); return; } currentWordList = shuffleArray([...wordThemes[theme]]); currentWordIndex = 0; currentLevel = 1; wordsCorrectThisLevel = 0; levelIndicator.textContent = `Maila: ${currentLevel}`; showScreen('wordGame'); loadWordChallenge(); addTouchListeners(); }
            function showWordThemeScreen(showCompletionMessage = false) { showScreen('wordThemeSelection'); wordFeedbackMessage.textContent = showCompletionMessage ? "Gaia osatu duzu! Oso ondo!" : 'Aukeratu gai bat'; wordFeedbackMessage.className = showCompletionMessage ? 'feedback correct' : 'feedback'; removeTouchListeners(); if (showCompletionMessage) { setTimeout(() => { if (wordThemeScreen.classList.contains('active')) { wordFeedbackMessage.textContent = 'Aukeratu gai bat'; wordFeedbackMessage.className = 'feedback'; } }, THEME_COMPLETE_DELAY_MS + 1000); } }
            function loadWordChallenge() { if (!currentWordList || currentWordList.length === 0) { console.error("Hitz-zerrenda baliogabea edo hutsa."); showWordThemeScreen(); return; } if (currentWordIndex >= currentWordList.length) { wordFeedbackMessage.textContent = "Gaia osatu duzu! Oso ondo! 🎉"; wordFeedbackMessage.className = 'feedback correct'; wordBoxesContainer.innerHTML = '<span style="font-size: 40px;">🏆</span>'; letterPoolContainer.innerHTML = ''; wordEmojiContainer.innerHTML = ''; wordEmojiContainer.style.display = 'none'; setTimeout(() => { showWordThemeScreen(true); }, THEME_COMPLETE_DELAY_MS); return; } const wordData = currentWordList[currentWordIndex]; currentWord = wordData.word.toUpperCase(); currentWordEmoji = wordData.emoji; lettersInBoxes = Array(currentWord.length).fill(null); wordEmojiContainer.textContent = currentWordEmoji; wordEmojiContainer.setAttribute('aria-label', `${wordData.word} hitzarentzako emojia`); wordEmojiContainer.style.display = 'flex'; wordBoxesContainer.innerHTML = ''; letterPoolContainer.innerHTML = ''; wordFeedbackMessage.textContent = 'Osatu hitza!'; wordFeedbackMessage.className = 'feedback'; for (let i = 0; i < currentWord.length; i++) { const box = document.createElement('div'); box.classList.add('word-box'); box.dataset.index = i; box.addEventListener('dragover', handleDragOver); box.addEventListener('dragleave', handleDragLeave); box.addEventListener('drop', handleDrop); wordBoxesContainer.appendChild(box); } const pool = generateLetterPool(currentWord, currentLevel); pool.forEach(letter => { const tile = document.createElement('div'); tile.classList.add('letter-tile'); tile.textContent = formatLetter(letter); tile.dataset.letter = letter; tile.draggable = true; tile.addEventListener('dragstart', handleDragStart); tile.addEventListener('dragend', handleDragEnd); tile.addEventListener('touchstart', handleTouchStart, { passive: false }); letterPoolContainer.appendChild(tile); }); applyOptions(); }
            function checkWordCompletion() { if (lettersInBoxes.every(letter => letter !== null)) { wordsCorrectThisLevel++; wordBoxesContainer.childNodes.forEach(box => box.classList.add('filled')); let message = ''; let delay = COMPLETION_DELAY_MS; let isLevelUp = false; if (wordsCorrectThisLevel >= WORDS_PER_LEVEL && currentWordIndex < currentWordList.length -1) { currentLevel++; wordsCorrectThisLevel = 0; levelIndicator.textContent = `Maila: ${currentLevel}`; message = `Zorionak! Hurrengo mailara pasa zara! (${currentLevel}. Maila) 🎉`; wordFeedbackMessage.className = 'feedback level-up'; wordBoxesContainer.childNodes.forEach(box => box.classList.add('level-up-flash')); delay = LEVEL_UP_DELAY_MS; isLevelUp = true; } else { message = `Zuzen! "${currentWord.toLowerCase()}" da! ✅`; wordFeedbackMessage.className = 'feedback correct'; } wordFeedbackMessage.textContent = message; setTimeout(() => { if (isLevelUp) { wordBoxesContainer.childNodes.forEach(box => box.classList.remove('level-up-flash')); } currentWordIndex++; loadWordChallenge(); }, delay); } }
            function addTouchListeners() { document.addEventListener('touchmove', handleTouchMove, { passive: false }); document.addEventListener('touchend', handleTouchEnd); }
            function removeTouchListeners() { document.removeEventListener('touchmove', handleTouchMove); document.removeEventListener('touchend', handleTouchEnd); }
            function handleTouchStart(event) { if (event.target.classList.contains('letter-tile')) { event.preventDefault(); draggedElement = event.target; const touch = event.changedTouches[0]; const rect = draggedElement.getBoundingClientRect(); offsetX = touch.clientX - rect.left; offsetY = touch.clientY - rect.top; createGhostElement(touch); draggedElement.classList.add('dragging'); } }
            function handleTouchMove(event) { if (!draggedElement || !ghostElement) return; event.preventDefault(); const touch = event.changedTouches[0]; ghostElement.style.left = `${touch.clientX - offsetX}px`; ghostElement.style.top = `${touch.clientY - offsetY}px`; ghostElement.style.display = 'none'; const elementBelow = document.elementFromPoint(touch.clientX, touch.clientY); ghostElement.style.display = ''; document.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over')); if (elementBelow && elementBelow.classList.contains('word-box') && !elementBelow.textContent) { elementBelow.classList.add('drag-over'); } }
            function handleTouchEnd(event) { if (!draggedElement) return; const touch = event.changedTouches[0]; let dropTarget = null; if (ghostElement) { ghostElement.style.display = 'none'; dropTarget = document.elementFromPoint(touch.clientX, touch.clientY); if (document.body.contains(ghostElement)) { document.body.removeChild(ghostElement); } ghostElement = null; } else { dropTarget = document.elementFromPoint(touch.clientX, touch.clientY); } document.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over')); if (dropTarget && dropTarget.classList.contains('word-box') && !dropTarget.textContent) { const droppedLetter = draggedElement.dataset.letter; const boxIndex = parseInt(dropTarget.dataset.index, 10); processDrop(droppedLetter, boxIndex, dropTarget); } else { if(draggedElement) draggedElement.classList.remove('dragging'); } if (ghostElement === null && !(dropTarget && dropTarget.classList.contains('word-box') && !dropTarget.textContent)) { draggedElement = null; } }
            function createGhostElement(touch) { if (ghostElement && document.body.contains(ghostElement)) { document.body.removeChild(ghostElement); } ghostElement = draggedElement.cloneNode(true); ghostElement.classList.add('touch-ghost'); ghostElement.style.position = 'absolute'; ghostElement.style.width = `${draggedElement.offsetWidth}px`; ghostElement.style.height = `${draggedElement.offsetHeight}px`; ghostElement.style.left = `${touch.clientX - offsetX}px`; ghostElement.style.top = `${touch.clientY - offsetY}px`; document.body.appendChild(ghostElement); }
            function handleDragStart(event) { draggedElement = event.target; event.dataTransfer.setData('text/plain', event.target.dataset.letter); event.dataTransfer.effectAllowed = 'move'; setTimeout(() => { if(draggedElement) draggedElement.classList.add('dragging'); }, 0); }
            function handleDragEnd(event) { if (draggedElement) { draggedElement.classList.remove('dragging'); } draggedElement = null; document.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over')); }
            function handleDragOver(event) { event.preventDefault(); event.dataTransfer.dropEffect = 'move'; if (event.target.classList.contains('word-box') && !event.target.textContent) { event.target.classList.add('drag-over'); } }
            function handleDragLeave(event) { if (event.target.classList.contains('word-box')) { event.target.classList.remove('drag-over'); } }
            function handleDrop(event) { event.preventDefault(); if (event.target.classList.contains('drag-over')) { event.target.classList.remove('drag-over'); } const targetBox = event.target; if (!targetBox.classList.contains('word-box') || targetBox.textContent !== '') { return; } const droppedLetter = event.dataTransfer.getData('text/plain'); const boxIndex = parseInt(targetBox.dataset.index, 10); processDrop(droppedLetter, boxIndex, targetBox); }
            function processDrop(droppedLetter, boxIndex, targetBox) { const originalDraggedElement = draggedElement; if (currentWord[boxIndex] === droppedLetter) { targetBox.textContent = formatLetter(droppedLetter); lettersInBoxes[boxIndex] = droppedLetter; targetBox.classList.add('correct-flash'); setTimeout(() => targetBox.classList.remove('correct-flash'), 500); if (originalDraggedElement && letterPoolContainer.contains(originalDraggedElement)) { letterPoolContainer.removeChild(originalDraggedElement); } if (draggedElement === originalDraggedElement) { draggedElement = null; } checkWordCompletion(); } else { targetBox.classList.add('incorrect-flash'); setTimeout(() => targetBox.classList.remove('incorrect-flash'), 500); if(originalDraggedElement) originalDraggedElement.classList.remove('dragging'); if (draggedElement === originalDraggedElement) { draggedElement = null; } } }

            // --- Number Game Logic ---
            function startNumberGame() { showScreen('numberGame'); loadNumberChallenge(); }
            function loadNumberChallenge() { numberGameActive = true; currentNumberCorrect = getRandomInt(1, 10); currentNumberEmoji = numberGameEmojis[getRandomInt(0, numberGameEmojis.length - 1)]; numberEmojiDisplay.innerHTML = ''; for (let i = 0; i < currentNumberCorrect; i++) { const emojiSpan = document.createElement('span'); emojiSpan.textContent = currentNumberEmoji; numberEmojiDisplay.appendChild(emojiSpan); } numberButtonsContainer.innerHTML = ''; for (let i = 1; i <= 10; i++) { const button = document.createElement('button'); button.classList.add('number-button'); button.textContent = i; button.dataset.number = i; button.addEventListener('click', handleNumberSelection); numberButtonsContainer.appendChild(button); } numberFeedbackMessage.textContent = 'Aukeratu zenbaki zuzena!'; numberFeedbackMessage.className = 'feedback'; setTimeout(() => { numberGameActive = false; }, 200); applyOptions(); }
            function handleNumberSelection(event) { if (numberGameActive) return; numberGameActive = true; const selectedButton = event.target.closest('.number-button'); if (!selectedButton) { numberGameActive = false; return; } const selectedNumber = parseInt(selectedButton.dataset.number, 10); if (selectedNumber === currentNumberCorrect) { numberFeedbackMessage.textContent = 'Zuzen! ✅'; numberFeedbackMessage.className = 'feedback correct'; selectedButton.classList.add('correct-flash'); numberButtonsContainer.querySelectorAll('.number-button').forEach(btn => btn.disabled = true); setTimeout(() => { selectedButton.classList.remove('correct-flash'); loadNumberChallenge(); }, NUMBER_CORRECT_DELAY_MS); } else { numberFeedbackMessage.textContent = 'Saiatu berriro! 🤔'; numberFeedbackMessage.className = 'feedback incorrect'; selectedButton.classList.add('incorrect-flash'); numberGameScreen.style.animation = 'shake 0.3s ease-in-out'; setTimeout(() => { selectedButton.classList.remove('incorrect-flash'); numberGameScreen.style.animation = ''; numberFeedbackMessage.textContent = 'Aukeratu zenbaki zuzena!'; numberFeedbackMessage.className = 'feedback'; numberGameActive = false; }, 800); } }

            // --- Options Modal Logic ---
            function openOptionsModal() { optionsModal.style.display = 'flex'; }
            function closeOptionsModal() { optionsModal.style.display = 'none'; }
            optionsButton.addEventListener('click', openOptionsModal);
            modalCloseButton.addEventListener('click', closeOptionsModal);
            optionsModal.addEventListener('click', (event) => { if (event.target === optionsModal) { closeOptionsModal(); } });
            fontStyleSelect.addEventListener('change', (event) => { fontStyleOption = event.target.value; applyOptions(); });
            letterCaseRadios.forEach(radio => { radio.addEventListener('change', (event) => { if (event.target.checked) { letterCaseOption = event.target.value; applyOptions(); } }); });

            // --- Initial Setup & Navigation ---
            gameSelectButtons.forEach(button => { button.addEventListener('click', () => { const gameType = button.dataset.game; if (gameType === 'words') { showScreen('wordThemeSelection'); } else if (gameType === 'numbers') { startNumberGame(); } }); });
            themeButtonsContainer.addEventListener('click', (event) => { const button = event.target.closest('.theme-button'); if (button) { startWordGame(button.dataset.theme); } });
            themeBackButton.addEventListener('click', () => showScreen('gameSelection'));
            wordBackButton.addEventListener('click', () => showScreen('wordThemeSelection'));
            numberBackButton.addEventListener('click', () => showScreen('gameSelection'));
            showScreen('gameSelection');
            applyOptions();

        });
    </script>
</body>
</html>
